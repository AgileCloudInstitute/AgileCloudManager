name: 'Configure Linux Agent'
description: 'Prepares Ubuntu-latest agents to be able to run acm commands.'
runs:
  using: "composite"
  steps:
    - shell: bash
      name: Configure agent
      run: |
        mkdir /home/runner/acmconfig/
        sudo mkdir /usr/acm
        sudo mkdir /usr/acm/keys
        sudo mkdir /usr/acm/keys/adminAccounts
        sudo chown -R runner:runner /usr/acm
        sudo chown -R runner:runner /home/runner/acmconfig/
        echo 'new------------------'
        az extension add --name resource-graph
        echo "Current working directory is: "
        pwd
        mkdir /home/runner/keys
        mkdir /home/runner/keys/starter
        sudo mkdir /var/log/acm
        sudo chown -R runner:runner /var/log/acm
        sudo mkdir /opt/acm
        sudo chown -R runner:runner /opt/acm
        git --version
        sudo apt install -y dos2unix
        ## Install Terraform
        cd /home/runner
        mkdir terraform-download
        cd terraform-download
        wget https://releases.hashicorp.com/terraform/0.12.24/terraform_0.12.24_linux_amd64.zip
        unzip terraform_0.12.24_linux_amd64.zip
        #Move the terraform binary into a folder that is listed as part of the PATH variable.  
        mv terraform /usr/local/bin/
        echo 'and---------------------------------'
        cd /home/runner
        sudo apt -y install ansible
        aws --version
        pip3 install requests
        pip3 install pyyaml
        pip3 install IPy
        python3 --version
        python --version
        #Cause the ansible configuration to be owned by the agent user so that pipelines can change things like hosts file, etc.  
        sudo chown -R runner:runner /opt/pipx_bin/ansible
        echo 'then--------------------------------'
        sudo apt update && sudo apt upgrade
        sudo apt clean
