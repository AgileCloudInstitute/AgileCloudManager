name: 'Configure Windows Agent'
description: 'Prepares Windows-latest agents to be able to run acm commands.'
runs:
  using: "composite"
  steps:
    - name: Configure agent
      shell: pwsh
      run: |
          #import base64, subprocess, sys, os, pathlib
          New-Item -ItemType Directory -Force -Path C:\\Users\\runneradmin\\acmconfig\\
          New-Item -ItemType Directory -Force -Path C:\\Users\\runneradmin\\acm\\
          New-Item -ItemType Directory -Force -Path C:\\Users\\runneradmin\\acm\\keys\\
          New-Item -ItemType Directory -Force -Path C:\\Users\\runneradmin\\acm\\keys\\adminAccounts\\
          py -m pip install requests
          py -m pip install PyYaml
          py -m pip install IPy
          py -m pip install pyinstaller
          echo "About to: az --version"
          az --version
          echo 'About to: "az extension add --name resource-graph"'
          az extension add --name resource-graph          
          New-Item -ItemType Directory -Force -Path C:\\Users\\runneradmin\\keys\\
          New-Item -ItemType Directory -Force -Path C:\\Users\\runneradmin\\keys\\starter\\
          New-Item -ItemType Directory -Force -Path C:\\Users\\runneradmin\\acm\\logs\\
          New-Item -ItemType Directory -Force -Path C:\\Users\\runneradmin\\acmhome\\
          New-Item -ItemType Directory -Force -Path D:\\a\\AgileCloudManager\\acmAdmin\\
          New-Item -ItemType Directory -Force -Path D:\\a\\AgileCloudManager\\acmAdmin\\binaries\\
          echo 'About to: git --version'
          git --version
          ## Install Terraform
          cd C:\\Users\\runneradmin\\
          New-Item -ItemType Directory -Force -Path C:\\Users\\runneradmin\\terraform-download\\
          cd C:\\Users\\runneradmin\\terraform-download\\
          curl -L https://releases.hashicorp.com/terraform/0.12.24/terraform_0.12.24_linux_amd64.zip -o terraform_0.12.24_linux_amd64.zip -H 'Accept: application/octet-stream'
          Expand-Archive -Path 'terraform_0.12.24_linux_amd64.zip' -DestinationPath 'D:\\a\\AgileCloudManager\\acmAdmin\\binaries\\'
          #Install ansible
          cd C:\\Users\\runneradmin
          py -m pip install ansible
          echo 'About to: ansible --version'
          ansible --version
          echo 'About to: where ansible'
          where ansible
          echo 'About to: aws --version'
          aws --version
          #Cause the ansible configuration to be owned by the agent user so that pipelines can change things like hosts file, etc.  
          #sudo chown -R runner:runner /opt/pipx_bin/ansible
